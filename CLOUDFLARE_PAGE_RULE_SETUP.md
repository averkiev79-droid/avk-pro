# Настройка Page Rule в Cloudflare для Яндекс-бота

## Цель
Создать правило, которое отключит прокси и усиленную защиту Cloudflare специально для Яндекс-бота, при этом оставив защиту для всех остальных посетителей.

---

## Пошаговая инструкция

### Шаг 1: Войти в панель Cloudflare
1. Открыть браузер и перейти на https://dash.cloudflare.com/
2. Войти в свой аккаунт Cloudflare
3. На главной странице выбрать домен **avk-pro.ru**

### Шаг 2: Перейти в раздел Page Rules
1. В левом меню найти и нажать **Rules** (Правила)
2. В выпадающем меню выбрать **Page Rules**
3. Нажать кнопку **Create Page Rule** (Создать правило страницы)

**Примечание:** В бесплатном плане Cloudflare доступно 3 правила Page Rules.

### Шаг 3: Настроить URL Pattern
В поле **If the URL matches** (Если URL совпадает) ввести:
```
avk-pro.ru/*
```

**Важно:** 
- Звездочка `*` означает "все страницы"
- Правило будет применяться ко всему сайту для указанных условий

### Шаг 4: Добавить настройки правила

Нажать кнопку **+ Add a Setting** и добавить следующие настройки:

#### Настройка 1: Security Level
1. Выбрать **Security Level** (Уровень безопасности)
2. Установить значение: **Essentially Off** (По сути выключено)

**Что это делает:** Снижает уровень проверок безопасности для Яндекс-бота

#### Настройка 2: Cache Level
1. Нажать **+ Add a Setting** еще раз
2. Выбрать **Cache Level** (Уровень кеширования)
3. Установить значение: **Standard** (Стандартный)

**Что это делает:** Позволяет кешировать контент для быстрой загрузки

#### Настройка 3: Disable Performance (ВАЖНО!)
1. Нажать **+ Add a Setting** еще раз
2. Выбрать **Disable Performance**
3. Поставить галочку (включить)

**Что это делает:** Отключает оптимизацию Cloudflare, которая может мешать боту

#### Настройка 4: Browser Integrity Check
1. Нажать **+ Add a Setting** еще раз
2. Выбрать **Browser Integrity Check** (Проверка целостности браузера)
3. Установить: **Off** (Выключено)

**Что это делает:** Отключает проверку браузера, которая может блокировать ботов

### Шаг 5: Условие для User-Agent (КРИТИЧНО!)

**ВНИМАНИЕ:** К сожалению, стандартные Page Rules не поддерживают фильтрацию по User-Agent напрямую. 

Для этого нужно использовать **Firewall Rules** или новые **WAF Custom Rules** (доступны в платных планах) либо **Transform Rules** (доступны в бесплатном плане с ограничениями).

---

## АЛЬТЕРНАТИВНЫЙ ПОДХОД: Firewall Rules (Рекомендуется)

Это более точное решение, которое работает ТОЛЬКО для Яндекс-бота.

### Вариант A: Transform Rules (Бесплатно, но ограничено)

1. В панели Cloudflare перейти в **Rules → Transform Rules**
2. Нажать **Create rule**
3. Выбрать **Modify Request Header**
4. Заполнить форму:

**Rule name:** `Allow Yandex Bot`

**When incoming requests match:**
- Field: **User Agent**
- Operator: **contains**
- Value: `YandexBot`

**OR**

- Field: **User Agent**  
- Operator: **contains**
- Value: `Yandex`

**Then:**
- Action: **Set static** 
- Header name: `X-Yandex-Bot`
- Value: `true`

5. Нажать **Deploy**

### Вариант B: Firewall Rules (Платный план или Trial)

1. Перейти в **Security → WAF**
2. Нажать **Create rule**
3. Заполнить:

**Rule name:** `Allow Yandex Bot`

**When incoming requests match:**
```
(http.user_agent contains "YandexBot") or (http.user_agent contains "Yandex")
```

**Then:**
- Action: **Skip**
- Choose which security features to skip:
  - ✅ All remaining custom rules
  - ✅ All managed rules
  - ✅ Security level
  - ✅ Hot link protection
  - ✅ Rate limiting rules
  - ✅ User agent blocking

4. Нажать **Deploy**

---

## ПРОСТОЕ РЕШЕНИЕ: Security Settings (Рекомендуется для начала)

Если вышеуказанные методы сложны, попробуйте глобально снизить защиту:

### Шаг 1: Понизить уровень безопасности
1. В Cloudflare перейти в **Security → Settings**
2. Найти **Security Level**
3. Установить на **Low** (Низкий) или **Essentially Off**
4. Нажать **Save**

### Шаг 2: Отключить Bot Fight Mode
1. В разделе **Security → Bots**
2. Найти **Bot Fight Mode**
3. Убедиться, что он **выключен** (Off)
4. Если включен - выключить

### Шаг 3: Проверить Challenge Passage
1. В **Security → Settings**
2. Найти **Challenge Passage**
3. Установить на **30 minutes** или больше

### Шаг 4: Отключить Browser Integrity Check
1. В **Security → Settings**
2. Найти **Browser Integrity Check**
3. Установить на **Off** (Выключено)

---

## Проверка настроек

После применения настроек подождите **5-10 минут** для применения изменений.

### Тест 1: Эмуляция Яндекс-бота через curl
```bash
curl -I -A "Mozilla/5.0 (compatible; YandexBot/3.0; +http://yandex.com/bots)" https://avk-pro.ru
```

**Ожидаемый результат:** HTTP 200 без лишних заголовков Cloudflare challenge

### Тест 2: Проверка в Яндекс.Вебмастере
1. Зайти в **Яндекс.Вебмастер** → **Инструменты**
2. Выбрать **Проверка ответа сервера**
3. Ввести URL: `https://avk-pro.ru`
4. Нажать **Проверить**

**Ожидаемый результат:** 
- Статус: **HTTP 200**
- Без ошибок DNS или подключения

### Тест 3: Запросить переобход
1. В Яндекс.Вебмастере перейти в **Индексирование → Переобход страниц**
2. Ввести URL: `https://avk-pro.ru`
3. Нажать **Отправить**
4. Повторить для основных страниц: `/catalog`, `/blog`, `/contacts`

---

## Рекомендуемая последовательность действий

### Вариант 1: Быстрый (5 минут)
1. ✅ Понизить Security Level до **Low**
2. ✅ Отключить Bot Fight Mode
3. ✅ Отключить Browser Integrity Check
4. ⏱️ Подождать 10 минут
5. ✅ Проверить в Яндекс.Вебмастере

### Вариант 2: Точный (15 минут, требует платный план)
1. ✅ Создать Firewall Rule для YandexBot
2. ✅ Настроить Skip для всех security features
3. ⏱️ Подождать 10 минут
4. ✅ Проверить через curl
5. ✅ Запросить переобход в Яндекс.Вебмастере

### Вариант 3: Временный (если ничего не помогло)
1. ✅ Временно отключить прокси Cloudflare (оранжевое → серое облачко)
2. ⏱️ Подождать 24-48 часов
3. ✅ Проверить индексацию Яндексом
4. ✅ Включить прокси обратно

---

## Мониторинг

### Проверяйте каждые 2-3 дня:
1. **Яндекс.Вебмастер → Диагностика → Проблемы сайта**
   - Не должно быть ошибок DNS
   
2. **Cloudflare Analytics → Traffic**
   - Должны появиться запросы от Yandex Bot

3. **Яндекс.Вебмастер → Индексирование → Страницы в поиске**
   - Количество проиндексированных страниц должно расти

---

## Что делать, если не помогло?

### Сценарий 1: Ошибка DNS осталась
1. Проверить NS-записи у регистратора домена
2. Убедиться, что NS указывают на Cloudflare
3. Проверить A-запись в Cloudflare (должна быть активна)
4. Связаться с техподдержкой Cloudflare

### Сценарий 2: Яндекс не видит сайт
1. Проверить в https://webmaster.yandex.ru/ раздел "Диагностика"
2. Сделать скриншот ошибки
3. Обратиться в поддержку Яндекс.Вебмастера
4. Предоставить результаты curl-тестов

### Сценарий 3: Cloudflare блокирует
1. Проверить **Security → Overview → Security Events**
2. Найти запросы от YandexBot
3. Посмотреть причину блокировки
4. Создать правило исключения для этой причины

---

## Контакты и ресурсы

- **Cloudflare Docs:** https://developers.cloudflare.com/firewall/
- **Яндекс.Вебмастер Help:** https://yandex.ru/support/webmaster/
- **Проверка User-Agent бота:** https://yandex.ru/support/webmaster/robot-workings/check-yandex-robots.html

---

## Чеклист выполнения

- [ ] Войти в Cloudflare Dashboard
- [ ] Security Level → Low
- [ ] Bot Fight Mode → Off
- [ ] Browser Integrity Check → Off
- [ ] Подождать 10 минут
- [ ] Протестировать через curl
- [ ] Проверить в Яндекс.Вебмастере
- [ ] Запросить переобход основных страниц
- [ ] Мониторить 3-5 дней
- [ ] ✅ Проблема решена!

---

## Заметки

**Дата настройки:** _____________

**Примененные правила:** 
- [ ] Security Level: Low
- [ ] Bot Fight Mode: Off
- [ ] Browser Integrity Check: Off
- [ ] Firewall Rule для YandexBot
- [ ] Другое: _______________

**Результат:** _____________
