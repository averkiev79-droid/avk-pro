# Скрипты управления базой данных

Эта папка содержит утилиты для резервного копирования и восстановления базы данных MongoDB.

## Доступные скрипты

### 1. backup_mongodb.sh

Создает резервную копию базы данных MongoDB.

**Использование:**
```bash
./scripts/backup_mongodb.sh
```

**Что делает скрипт:**
- Создает резервную копию базы данных `test_database`
- Сохраняет резервную копию в `/app/backups/backup_YYYYMMDD_HHMMSS/`
- Автоматически удаляет резервные копии старше 7 дней
- Показывает размер созданной резервной копии
- Выводит список всех доступных резервных копий

**Пример вывода:**
```
========================================
  MongoDB Backup Script
========================================

База данных: test_database
Директория: /app/backups
Дата/время: 20241116_143022

Создание резервной копии...

✓ Резервная копия успешно создана!
  Путь: /app/backups/backup_20241116_143022
  Размер: 2.4M

✓ Удалено старых резервных копий: 3

Доступные резервные копии:
  backup_20241116_143022 - 2.4M
  backup_20241115_020000 - 2.3M
  backup_20241114_020000 - 2.2M

✓ Резервное копирование завершено успешно!
========================================
```

---

### 2. restore_mongodb.sh

Восстанавливает базу данных из резервной копии.

**Использование:**

Без параметров - показывает список доступных резервных копий:
```bash
./scripts/restore_mongodb.sh
```

С номером резервной копии:
```bash
./scripts/restore_mongodb.sh 1
```

С полным путем к резервной копии:
```bash
./scripts/restore_mongodb.sh /app/backups/backup_20241116_143022/
```

**Что делает скрипт:**
- Показывает список доступных резервных копий с размерами
- Запрашивает подтверждение перед восстановлением
- Удаляет текущие данные и восстанавливает из резервной копии
- Показывает статистику восстановленной базы данных

**Пример вывода:**
```
========================================
  MongoDB Restore Script
========================================

Доступные резервные копии:

  [1] backup_20241116_143022 (размер: 2.4M)
  [2] backup_20241115_020000 (размер: 2.3M)
  [3] backup_20241114_020000 (размер: 2.2M)

Использование:
  ./restore_mongodb.sh <номер_резервной_копии>
  или
  ./restore_mongodb.sh <полный_путь_к_резервной_копии>

Пример:
  ./restore_mongodb.sh 1  - восстановить самую свежую резервную копию
  ./restore_mongodb.sh /app/backups/backup_20241116_120000/
```

---

## Быстрый старт

### 1. Создать резервную копию

```bash
cd /app
./scripts/backup_mongodb.sh
```

### 2. Восстановить из резервной копии

```bash
# Посмотреть список резервных копий
./scripts/restore_mongodb.sh

# Восстановить последнюю резервную копию
./scripts/restore_mongodb.sh 1
```

---

## Автоматизация

### Настройка автоматического резервного копирования

Добавьте задачу в crontab для автоматического резервного копирования:

```bash
# Открыть редактор crontab
crontab -e

# Добавить задачу (резервное копирование каждый день в 2:00)
0 2 * * * /app/scripts/backup_mongodb.sh >> /var/log/mongodb_backup.log 2>&1
```

**Популярные варианты расписания:**

```bash
# Каждый день в 2:00
0 2 * * * /app/scripts/backup_mongodb.sh >> /var/log/mongodb_backup.log 2>&1

# Каждые 6 часов
0 */6 * * * /app/scripts/backup_mongodb.sh >> /var/log/mongodb_backup.log 2>&1

# Каждую неделю (воскресенье в 3:00)
0 3 * * 0 /app/scripts/backup_mongodb.sh >> /var/log/mongodb_backup.log 2>&1

# Каждый час
0 * * * * /app/scripts/backup_mongodb.sh >> /var/log/mongodb_backup.log 2>&1
```

### Просмотр логов

```bash
# Посмотреть логи резервного копирования
tail -f /var/log/mongodb_backup.log

# Посмотреть последние 50 строк
tail -n 50 /var/log/mongodb_backup.log
```

---

## Устранение неполадок

### Ошибка: "command not found: mongodump"

Установите MongoDB Database Tools:

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y mongodb-database-tools

# Проверить установку
mongodump --version
mongorestore --version
```

### Ошибка: "Failed: error connecting to db server"

Проверьте, что MongoDB запущен:

```bash
# Проверить статус
sudo systemctl status mongod

# Или проверить процесс
ps aux | grep mongod
```

### Ошибка: "Permission denied"

Убедитесь, что скрипты имеют права на выполнение:

```bash
chmod +x /app/scripts/backup_mongodb.sh
chmod +x /app/scripts/restore_mongodb.sh
```

### Нет места на диске

Удалите старые резервные копии:

```bash
# Удалить резервные копии старше 7 дней
find /app/backups -type d -name "backup_*" -mtime +7 -exec rm -rf {} \;

# Или удалить все резервные копии кроме последних 3
cd /app/backups
ls -t | grep backup_ | tail -n +4 | xargs rm -rf
```

---

## Рекомендации

1. **Регулярность**: Настройте автоматическое резервное копирование через cron
2. **Хранение**: Храните резервные копии минимум за последние 7 дней
3. **Проверка**: Периодически проверяйте, что резервные копии можно восстановить
4. **Удаленное хранение**: Копируйте важные резервные копии в облако (S3, Google Cloud Storage)
5. **Мониторинг**: Следите за размером папки `/app/backups` и свободным местом на диске

---

## Дополнительные ресурсы

Подробное руководство по резервному копированию MongoDB доступно в файле `/app/MONGO_BACKUP_GUIDE.md`
